# 架构对比：CrewAI自动化 vs MCP工具分离

## 架构A：CrewAI完全自动化

```
┌──────────────────────────────────────────────────────────┐
│                    用户输入查询                            │
│           "分析贵州茅台过去一年的股票表现"                  │
└────────────────────┬─────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────┐
│                 finance_crew.py                          │
│                                                          │
│  crew.kickoff(inputs={"query": query})                  │
│                                                          │
│  ┌────────────────────────────────────────────────┐    │
│  │  Agent 1: 中国A股数据分析师                     │    │
│  │  Task: Query Parsing                           │    │
│  │  Output: {                                     │    │
│  │    stock_codes: ["600519"],                   │    │
│  │    stock_names: ["贵州茅台"],                  │    │
│  │    timeframe: "365",                          │    │
│  │    action: "分析"                              │    │
│  │  }                                             │    │
│  └──────────────┬─────────────────────────────────┘    │
│                 │                                        │
│                 ▼                                        │
│  ┌────────────────────────────────────────────────┐    │
│  │  Agent 2: 高级Python开发工程师                  │    │
│  │  Task: Code Writing                            │    │
│  │  Output: """                                   │    │
│  │    import akshare as ak                        │    │
│  │    def analyze_stock():                        │    │
│  │        df = ak.stock_zh_a_hist(...)           │    │
│  │        # ... 分析代码 ...                      │    │
│  │        plt.show()                              │    │
│  │  """                                           │    │
│  └──────────────┬─────────────────────────────────┘    │
│                 │                                        │
│                 ▼                                        │
│  ┌────────────────────────────────────────────────┐    │
│  │  Agent 3: Code Execution Expert                │    │
│  │  Task: Code Execution                          │    │
│  │  Settings: allow_code_execution=True           │    │
│  │                                                │    │
│  │  在CrewAI沙箱中执行:                            │    │
│  │  ├─> 审查代码                                   │    │
│  │  ├─> exec(generated_code)                     │    │
│  │  ├─> 捕获输出和错误                             │    │
│  │  └─> 返回执行结果                               │    │
│  └──────────────┬─────────────────────────────────┘    │
│                 │                                        │
└─────────────────┼────────────────────────────────────────┘
                  │
                  ▼
┌──────────────────────────────────────────────────────────┐
│              返回 result.raw                              │
│  包含: 生成的代码 + 执行结果 + 可能的输出                   │
└──────────────────────────────────────────────────────────┘

特点:
✅ 全自动化，一次调用完成所有步骤
✅ Agent之间自动协作
✅ 自动错误修复（Agent3可以委托Agent2重新生成代码）
❌ 代码在沙箱执行，可能受限
❌ 代码不自动保存
❌ 用户无法干预过程
```

---

## 架构B：MCP工具分离

```
┌──────────────────────────────────────────────────────────┐
│                    Cursor AI 聊天框                        │
│           "分析贵州茅台过去一年的股票表现"                  │
└────────────────────┬─────────────────────────────────────┘
                     │
                     │ Cursor识别MCP工具
                     ▼
┌──────────────────────────────────────────────────────────┐
│                    MCP Server (server.py)                 │
│                                                          │
│  工具1: analyze_stock(query)                             │
│  ┌────────────────────────────────────────────────┐    │
│  │  def analyze_stock(query: str) -> str:        │    │
│  │      result = run_financial_analysis(query)   │    │
│  │      return result  # 返回生成的代码字符串      │    │
│  └──────────────┬─────────────────────────────────┘    │
│                 │                                        │
│                 │ 调用 finance_crew.py                   │
│                 ▼                                        │
│  ┌──────────────────────────────────────────┐          │
│  │     CrewAI执行（同架构A）                 │          │
│  │  Agent1 → Agent2 → Agent3                │          │
│  │  返回: 生成的Python代码                   │          │
│  └──────────────┬───────────────────────────┘          │
└─────────────────┼────────────────────────────────────────┘
                  │
                  ▼
┌──────────────────────────────────────────────────────────┐
│              Cursor显示生成的代码                          │
│  用户可以: 查看、修改、询问                                │
└────────────────────┬─────────────────────────────────────┘
                     │
                     │ 用户: "保存这个代码"
                     ▼
┌──────────────────────────────────────────────────────────┐
│              MCP Server (server.py)                       │
│                                                          │
│  工具2: save_code(code)                                  │
│  ┌────────────────────────────────────────────────┐    │
│  │  def save_code(code: str) -> str:             │    │
│  │      with open('stock_analysis.py', 'w') as f: │    │
│  │          f.write(code)                         │    │
│  │      return "Code saved"                       │    │
│  └────────────────────────────────────────────────┘    │
└────────────────────┬─────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────┐
│           本地文件: stock_analysis.py                      │
│  用户可以: 手动编辑、版本控制、重用                         │
└────────────────────┬─────────────────────────────────────┘
                     │
                     │ 用户: "运行这个分析"
                     ▼
┌──────────────────────────────────────────────────────────┐
│              MCP Server (server.py)                       │
│                                                          │
│  工具3: run_code_and_show_plot()                         │
│  ┌────────────────────────────────────────────────┐    │
│  │  def run_code_and_show_plot() -> str:          │    │
│  │      with open('stock_analysis.py', 'r') as f: │    │
│  │          exec(f.read())                        │    │
│  │      # 在用户本地环境执行                       │    │
│  └────────────────────────────────────────────────┘    │
└────────────────────┬─────────────────────────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────┐
│              本地生成的文件                                │
│  - 600519_贵州茅台_analysis_20251008.png                  │
│  - 控制台统计输出                                         │
└──────────────────────────────────────────────────────────┘

特点:
✅ 用户有完全控制权，可以在任何步骤暂停
✅ 代码保存在本地，可重用和修改
✅ 在用户本地环境执行，无沙箱限制
✅ 图表文件直接保存在项目目录
✅ 支持迭代和渐进式开发
⚠️ 需要多次工具调用（但更灵活）
```

---

## 关键差异对比表

| 维度 | 架构A (CrewAI自动化) | 架构B (MCP工具分离) |
|------|---------------------|-------------------|
| **调用方式** | 一次性调用 `crew.kickoff()` | 分三次调用MCP工具 |
| **执行环境** | CrewAI内部沙箱 | 用户本地环境 |
| **代码保存** | ❌ 不保存（只返回字符串） | ✅ 保存到 `stock_analysis.py` |
| **用户控制** | ❌ 无法干预（全自动） | ✅ 每步都可控制 |
| **代码可见性** | ⚠️ 作为结果返回 | ✅ 本地文件，可查看编辑 |
| **图表输出** | ⚠️ 在沙箱中，可能难以访问 | ✅ 直接保存在项目目录 |
| **错误处理** | ✅ Agent自动修复 | ⚠️ 用户手动处理 |
| **迭代开发** | ❌ 需要重新生成 | ✅ 可以直接修改文件 |
| **适用场景** | 快速自动化、批量处理 | 探索性分析、学习、调试 |

---

## 实际使用流程对比

### 场景：分析贵州茅台，然后修改时间范围

#### 使用架构A (CrewAI)
```bash
# 第一次分析（一年）
uv run finance_crew.py
# 输入: "分析贵州茅台过去一年的股票表现"
# → 生成代码 → 执行 → 返回结果

# 修改为半年，需要重新生成
uv run finance_crew.py  
# 输入: "分析贵州茅台过去半年的股票表现"
# → 重新生成代码 → 重新执行 → 返回结果
```

**问题：**
- 每次修改都要重新生成代码
- 无法保存之前的分析结果
- 无法直接修改生成的代码

---

#### 使用架构B (MCP)
```
在Cursor中:

你: "分析贵州茅台过去一年的股票表现"
  └─> MCP调用: analyze_stock()
  └─> 返回: Python代码

你: "保存这个代码"
  └─> MCP调用: save_code()
  └─> 保存: stock_analysis.py

你: "运行"
  └─> MCP调用: run_code_and_show_plot()
  └─> 生成: 600519_贵州茅台_analysis_xxx.png

# 现在修改时间范围
你: "把时间改成半年"
  └─> Cursor直接编辑 stock_analysis.py
  └─> 修改: days=365 → days=180

你: "重新运行"
  └─> MCP调用: run_code_and_show_plot()
  └─> 生成新图表（无需重新生成代码！）
```

**优势：**
- ✅ 代码只生成一次
- ✅ 后续修改直接编辑文件
- ✅ 所有版本都可保存
- ✅ 图表文件都在本地

---

## 为什么需要两种架构？

### 架构A适合的场景：
1. **批量自动化处理**
   ```bash
   for stock in ["600519", "601398", "600036"]:
       analyze_stock(stock)  # 全自动
   ```

2. **一次性快速分析**
   - 不需要保存代码
   - 只关心结果
   - 不需要修改

3. **Agent学习和演示**
   - 展示多Agent协作
   - 自动错误修复

---

### 架构B适合的场景：
1. **探索性数据分析**
   - 反复修改参数
   - 尝试不同的可视化
   - 保存不同版本

2. **学习和教学**
   - 查看生成的代码
   - 理解分析逻辑
   - 学习akshare使用

3. **生产环境部署**
   - 代码需要版本控制
   - 需要代码审查
   - 需要持续集成

4. **交互式开发**
   - 在Cursor中实时交互
   - 根据结果调整分析
   - 保存和重用代码

---

## 实现细节

### CrewAI的代码执行机制

```python
# finance_crew.py
code_execution_agent = Agent(
    role="Senior Code Execution Expert",
    allow_code_execution=True,  # 关键设置
    allow_delegation=True,
    ...
)
```

**这个设置的作用：**
1. CrewAI自动添加 `CodeInterpreterTool`
2. Agent可以在沙箱中执行代码
3. 可以捕获执行结果和错误
4. 出错时可以委托给Code Writer Agent修复

**限制：**
- 沙箱环境可能有文件系统限制
- 生成的图表可能难以直接访问
- 执行结果只能通过Agent返回

---

### MCP工具的执行机制

```python
# server.py
@mcp.tool()
def run_code_and_show_plot() -> str:
    with open('stock_analysis.py', 'r') as f:
        exec(f.read())  # 在用户环境执行
```

**这个设置的作用：**
1. 代码在用户的Python环境执行
2. 完全访问文件系统
3. 图表直接保存在当前目录
4. 可以使用用户安装的所有库

**优势：**
- 无沙箱限制
- 图表文件直接可访问
- 可以与其他本地工具集成

---

## 总结

### 架构设计哲学

**架构A (CrewAI)：**
> "我帮你把所有事情都做了"
- 黑盒自动化
- 快速但不灵活
- 适合标准化流程

**架构B (MCP工具)：**
> "我给你工具，你自己组装"
- 白盒可控化
- 灵活但需要多步
- 适合探索和定制

### 最佳实践

**推荐的使用模式：**

1. **初次使用** → 架构B
   - 学习系统如何工作
   - 查看生成的代码
   - 理解分析流程

2. **熟悉后** → 架构A或B都可以
   - 标准分析 → 架构A（快速）
   - 定制分析 → 架构B（灵活）

3. **生产环境** → 架构B
   - 代码需要审查
   - 需要版本控制
   - 需要CI/CD集成

---

**最终答案：**

`save_code()` 和 `run_code_and_show_plot()` 不是冗余，而是提供了一种**更灵活、更可控的工作模式**，让用户可以：
1. 查看和修改生成的代码
2. 在本地环境执行（无沙箱限制）
3. 保存和重用代码
4. 支持迭代式开发

这是**用户控制 vs 自动化**的权衡，两种模式各有优势，取决于具体使用场景！

