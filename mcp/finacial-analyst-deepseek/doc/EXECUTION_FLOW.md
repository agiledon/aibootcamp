# 执行流程详解

## 问题：当在Cursor中输入"分析贵州茅台(600519)过去一年的股票表现"时，整个执行流程是怎样的？

## 完整执行流程

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Cursor AI 聊天框                                              │
│  输入: "分析贵州茅台(600519)过去一年的股票表现"                    │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 识别到 MCP 工具
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  2. MCP Server (server.py)                                       │
│  调用工具: analyze_stock(query)                                  │
│  └─> 内部调用: run_financial_analysis(query)                     │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         │ 启动 CrewAI
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  3. CrewAI Crew (finance_crew.py)                               │
│  按顺序执行三个任务                                               │
└─────────────────────────────────────────────────────────────────┘
                         │
                         ├─> 任务1: Query Parsing
                         │   ┌─────────────────────────────────────┐
                         │   │ Agent: 中国A股数据分析师              │
                         │   │ 输入: "分析贵州茅台(600519)过去一年..." │
                         │   │ 输出: {                               │
                         │   │   stock_codes: ["600519"],           │
                         │   │   stock_names: ["贵州茅台"],          │
                         │   │   timeframe: "365",                  │
                         │   │   action: "分析"                      │
                         │   │ }                                     │
                         │   └─────────────────────────────────────┘
                         │
                         ├─> 任务2: Code Writing
                         │   ┌─────────────────────────────────────┐
                         │   │ Agent: 高级Python开发工程师           │
                         │   │ 输入: 解析后的股票信息                │
                         │   │ 输出: 完整的Python代码字符串          │
                         │   │                                      │
                         │   │ 生成的代码包含:                       │
                         │   │ - import akshare as ak              │
                         │   │ - 获取股票数据                        │
                         │   │ - 计算统计指标                        │
                         │   │ - 创建4个可视化图表                   │
                         │   │ - 保存图表为PNG                       │
                         │   └─────────────────────────────────────┘
                         │
                         └─> 任务3: Code Execution
                             ┌─────────────────────────────────────┐
                             │ Agent: Code Execution Expert        │
                             │ 功能: 审查和执行代码                  │
                             │ 设置: allow_code_execution=True     │
                             │                                      │
                             │ 在CrewAI的沙箱环境中:                │
                             │ 1. 审查代码安全性                    │
                             │ 2. 执行代码                          │
                             │ 3. 捕获错误并修复                    │
                             │ 4. 返回执行结果                      │
                             └─────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  4. 返回结果                                                      │
│  CrewAI返回: result.raw (包含生成的代码和执行结果)                │
└────────────────────────┬────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────────┐
│  5. Cursor显示                                                   │
│  显示生成的Python代码 + 可能的执行结果                            │
└─────────────────────────────────────────────────────────────────┘
```

## 为什么需要 save_code() 和 run_code_and_show_plot()？

### 设计理念对比

#### 方案A：纯CrewAI自动化（当前 finance_crew.py 的实现）
```python
# finance_crew.py 中的流程
crew.kickoff() 
  ├─> 解析查询
  ├─> 生成代码
  └─> 执行代码（在CrewAI沙箱中）
```

**优点：**
- ✅ 全自动化，一步到位
- ✅ 代码生成和执行都在Agent控制下

**缺点：**
- ❌ 代码执行在CrewAI的沙箱环境中，可能有限制
- ❌ 用户无法控制执行时机
- ❌ 难以保存和重用生成的代码
- ❌ 图表可能只在沙箱中生成，不易查看

#### 方案B：MCP工具分离（server.py 提供的三个工具）
```python
# server.py 提供三个独立工具
@mcp.tool() analyze_stock()    # 生成代码
@mcp.tool() save_code()         # 保存代码
@mcp.tool() run_code_and_show_plot()  # 执行代码
```

**优点：**
- ✅ 用户有更多控制权
- ✅ 可以分步执行
- ✅ 代码保存在本地，可重用
- ✅ 图表在本地生成，易于查看
- ✅ 适合渐进式工作流

**缺点：**
- ⚠️ 需要多次工具调用
- ⚠️ 流程稍显复杂

## 两种使用场景

### 场景1：完全自动化（直接运行 finance_crew.py）
```bash
uv run finance_crew.py
```

**执行流程：**
```
用户 → CrewAI → 自动完成全部流程 → 返回结果
```

**适用于：**
- 快速测试
- 批量处理
- 不需要交互的场景

---

### 场景2：交互式MCP工作流（通过Cursor）

#### 步骤1：生成代码
```
Cursor: "分析贵州茅台过去一年的股票表现"
  ↓
MCP调用: analyze_stock(query)
  ↓
CrewAI执行: 三个Agent协作生成代码
  ↓
返回: Python代码字符串
```

**用户得到：**
```python
# 生成的代码示例
import akshare as ak
import pandas as pd
import matplotlib.pyplot as plt

def analyze_stock():
    df = ak.stock_zh_a_hist(symbol="600519", ...)
    # ... 分析代码 ...
    plt.show()

if __name__ == "__main__":
    analyze_stock()
```

#### 步骤2：保存代码（可选）
```
Cursor: "保存这段代码"
  ↓
MCP调用: save_code(code, filename="stock_analysis.py")
  ↓
写入文件: output/stock_analysis.py
```

**好处：**
- 代码持久化在本地output目录
- 可以手动修改和调试
- 可以重复使用
- 统一管理生成的文件

#### 步骤3：执行代码
```
Cursor: "运行这个分析"
  ↓
MCP调用: run_code_and_show_plot(filename="stock_analysis.py")
  ↓
切换到output目录并执行: exec(open('stock_analysis.py').read())
  ↓
结果: 在output目录生成图表PNG文件
```

**好处：**
- 在用户本地环境执行
- 图表统一保存在output目录
- 可以查看中间结果
- 便于管理和清理生成的文件

---

## 关键区别总结

| 特性 | CrewAI内部执行 | MCP工具分离 |
|------|---------------|------------|
| **执行环境** | CrewAI沙箱 | 用户本地环境 |
| **代码保存** | 不自动保存 | 保存到本地文件 |
| **用户控制** | 自动化，无控制 | 分步执行，可控 |
| **图表查看** | 可能受限 | 直接保存本地 |
| **代码重用** | 困难 | 简单 |
| **适用场景** | 快速自动化 | 交互式开发 |

## 实际使用示例

### 示例1：一次性自动化分析
```bash
# 直接运行，全自动
uv run finance_crew.py
```

### 示例2：在Cursor中交互式分析
```
你: "分析贵州茅台过去一年的表现"
  └─> 调用 analyze_stock() 
  └─> 返回代码

你: "保存这个代码"
  └─> 调用 save_code()
  └─> 保存到 output/stock_analysis.py

你: "现在运行它"
  └─> 调用 run_code_and_show_plot()
  └─> 生成图表 output/600519_贵州茅台_analysis_xxx.png

你: "修改时间范围为6个月，重新运行"
  └─> 可以编辑 output/stock_analysis.py
  └─> 再次调用 run_code_and_show_plot()
```

### 示例3：对比多个股票
```
你: "对比贵州茅台和五粮液的表现"
  └─> analyze_stock() 生成对比代码

你: "保存代码"
  └─> save_code() 

你: "执行"
  └─> run_code_and_show_plot()
  └─> 生成对比图表
```

## 为什么这样设计？

### 1. 灵活性
MCP工具分离提供了更大的灵活性，用户可以：
- 只生成代码，不执行
- 修改代码后再执行
- 多次执行同一代码（不同参数）

### 2. 可观察性
分步执行让用户可以：
- 检查生成的代码质量
- 理解分析逻辑
- 学习如何使用akshare

### 3. 可控性
用户可以决定：
- 何时保存代码
- 何时执行代码
- 是否修改代码

### 4. 兼容性
两种模式都支持：
- CrewAI内部执行（快速自动化）
- MCP工具执行（交互式控制）

## 总结

**finance_crew.py** 的三个Agent已经实现了完整的流程，但那是在CrewAI的控制下自动执行的。

**server.py** 的额外工具（save_code, run_code_and_show_plot）提供了：
1. **用户控制权**：用户决定何时执行
2. **代码持久化**：保存到本地文件
3. **本地执行**：在用户环境中运行
4. **交互式工作流**：更适合探索性分析

这种设计让系统既支持**全自动化**（适合批量处理），也支持**交互式**（适合探索性分析），是一种灵活且强大的架构设计。

---

**类比：**
- CrewAI内部执行 = 一键式洗衣机（放进去就自动完成）
- MCP工具分离 = 手动控制洗衣机（可以选择洗涤、漂洗、脱水的顺序和次数）

两种方式各有优势，取决于使用场景！

