+3chroma:document限界上下文

细胞之所以能够存在，是因为细胞膜限定了什么在细胞内，什么在细胞外，并且确定了什么物质可以通过细胞膜。

——Eric Evans



我曾经有机会向Event Storming的提出者Alberto Brandolini请教他对限界上下文的理解。他做了一个非常精彩的总结：限界上下文意味着安全（bounded context are a mean of safety)。我问他安全（Safety）应做何解？他解释说：安全就在于控制，不会带来惊讶（being in control and no surprise）。控制，意味着目标系统的架构与组织结构是可控的；没有出乎意料的惊讶，虽然显得不够浪漫，却能让团队避免过大的压力。正如Alberto进一步告诉我：“出乎意料的惊讶会导致压力，而压力就会使得团队疲于加班，缺少学习。”（Surprise leads to stress and stress leads to no learning, just hard work.）

这当然是真正看破限界上下文本质的大师高论！然而曲高和寡，这一本质理解并不能解除我们对限界上下文的困惑。虽说限界上下文的重要性无需多言，随着微服务的兴起，它更是被拔高到战略设计的核心地位，也成为了连接问题空间与解空间的重要桥梁。但不可否认的是，一方面，领域驱动设计社区纷纷发出声音强调它的重要性；另一方面，还是有很多人依旧弄不清楚限界上下文到底是什么？

10.1 限界上下文的定义

什么是限界上下文（Bounded Context）？我认为，要明确限界上下文的定义，需要从Bounded与Context这两个单词的含义来理解。Context表现了业务流程的场景片段。整个业务流程由诸多具有时序的活动组成，随着流程的进行，不同的活动需要不同的角色参与，并导致上下文因为某个活动的执行发生切换。因而，上下文（Context）其实是动态的业务流程被边界（Bounded）静态切分的产物。

假设这样一个业务场景。我作为一名咨询师从成都出发前往深圳为客户做领域驱动设计的咨询。无论是从家乘坐地铁到达成都双流机场，还是乘坐飞机到达深圳宝安机场，再从宝安机场乘坐出租车到达酒店，我的身份都是一名乘客（Passenger），虽然因为交通工具的不同，参与的活动也不尽相同，但无论上车下车，还是办理登机手续、安检、登机以及下机等活动，都与交通出行有关。

那么，是否我坐在交通工具上，就一定代表我属于这个上下文？未必！注意，其实交通出行上下文模糊了“我”而强调了“乘客”这个概念。这一概念代表了参与到该上下文的“角色”，或者说“身份”。我坐在飞机上，忽然想起给客户提供的咨询方案有待完善。于是我拿出电脑，在一万米高空之上继续完善我的领域驱动设计咨询方案。此时的我虽然还在飞机上，身份却切换成了一名咨询师（Consultant），执行的业务活动也与咨询内容有关，当前的上下文也就从出行上下文切换到了咨询上下文。

当我作为乘客乘坐出租车前往酒店，并至前台办理入住手续时，我又“撕下了乘客的面具”，摇身一变成为酒店上下文的宾客（Guest）角色，上下文随之切换为住宿上下文。次日清晨，我离开酒店前往客户公司。随着我走出酒店这一活动的发生，住宿上下文又切换回交通出行。当我到达客户所在地时，面对客户，我开始以一名咨询师身份与客户团队交谈，了解他们的咨询目标与现有痛点。我制定咨询计划与方案，并与客户一起评审咨询方案，于是，上下文又切换为咨询工作了。

无论是交通出行还是入住酒店，都需要支付费用。支付的费用虽然不同，支付的行为也有所差别，需要用到的领域知识却是相同的，因此支付活动又可以归为支付上下文。

上下文在流程中的切换犹如电影画面的场景切换，相同的人物扮演了不同的角色，在不同的上下文参与了不同的活动。由于活动的目标发生了改变，履行的职责亦有所不同。上述场景如图10-1所示： 


图10-1 咨询活动的上下文切换

整个业务流程由诸多活动组成，这些活动有着不同的角色参与。在不同上下文中，角色与角色之间通过活动产生协作，以满足业务流程的需求。这些活动是分散的，活动的目标也不相同，但在同一个上下文中，这些活动却为同一个目标提供服务。

显然，每个限界上下文各自代表了不同的业务能力（Business Capability），以满足参与到当前上下文中的各个角色的目标。这些角色只会执行满足当前限界上下文业务能力的活动，这是因为限界上下文划定了领域知识的边界，不同的限界上下文需要不同的领域知识，形成了各自的知识语境。业务能力与领域知识存在业务相关性，要提供该业务能力，需要具备对应的领域知识。领域知识由限界上下文的领域模型对象所拥有，或者说，这些领域模型对象共同提供了符合当前知识语境的业务能力，并被分散到对象扮演的角色之上，由它履行的活动来体现。如果该角色执行该活动却不具备对应的领域知识，说明对活动的分配不合理；如果该活动的目标与该限界上下文保持一致，却缺乏相应知识，说明该活动需要与别的限界上下文协作。领域模型对象、角色、领域知识、活动、知识语境以及业务能力之间的关系可以通过图10-2形象的展现。

图10-2 限界上下文的关键要素

为了更形象地说明限界上下文关键要素的关系，我们来看看一个物流运输系统的案例。该系统能够支持集装箱在铁路运输与公路运输的多式联运。系统需要计算每次多式联运的运费，以管理公司与委托公司之间的往来账。系统定义了运输上下文和财务上下文，现在思考一下，运费计算活动是否可以放在财务上下文？

如果从“知识”和“能力”的角度去理解，财务上下文的领域模型对象并不具备计算运费的业务知识，它们不了解运输过程中的各种费率，如运输费、货站租赁费、货物装卸人工费、保费，也不了解运输费用的计算规则。缺乏这些知识，自然也就不具备计算运费的能力。财务上下文其实只需要获得与往来账有关的结算费用，而不是具体的运费计算过程。

既然不具备计算运费的能力，就不应该将运费计算活动放到财务上下文中，而应考虑放到运输上下文，因为计算运费需要的领域知识都在它的知识语境内。由于财务需要运费计算的结果，说明财务上下文需要运输上下文的支持，调用它提供的业务能力。结合前面对限界上下文的理解，生成运输委托往来账的业务场景就可体现为两个限界上下文业务能力的协作，如图10-3所示。 


图10-3 业务能力的协作

以某个角色履行活动的领域模型对象，拥有了提供业务能力的领域知识，领域知识的语境决定了上下文的边界，这就是限界上下文的根本意义。上下文（Context）体现了业务能力，限界（Bounded）则是保护和隔离上下文的边界，形成了领域模型的知识语境，维护了领域概念的一致性与完整性。

10.2限界上下文的特征

根据限界上下文的定义，我们可以明确它的业务特征与设计特征。在识别限界上下文时，必须满足如下业务特征：

它是领域模型的知识语境

它体现了业务能力的纵向切分

在设计限界上下文时，必须满足如下设计特征：

它是自治的架构单元

10.2.1领域模型的知识语境

让我们先来读一个句子：

wǒ yǒu kuài dì

到底是什么意思？ 究竟是——我有快递——还是——我有块地？哪个意思才是正确的呢？确定不了，或者说即使确定了也可能引起误解！我们需要结合说话人说这句话的前后句子来理解。例如：

wǒ yǒu kuài dì，zǔ shàng liú xià lái de ——> 我有块地，祖上留下来的。

wǒ yǒu kuài dì，shùn fēng de ——> 我有快递，顺丰的。

也可能需要结合说话人当时的语境和语气来理解。例如，办公室职员小王在工作时间下楼，遇见同事，同事问他干嘛，他回答说：“wǒ yǒu kuài dì”，显然，小王的意思是“我有快递”；政府要将城西近郊的一片农田建设为经济开发区，小王洋洋得意地指着那片待开发的农田向朋友吹嘘：“wǒ yǒu kuài dì”，不用说，小王因为自己有块地在城西，可以分得不少占地费用了。

在日常对话中，说话的语气与语境，还有前后句子都是帮助我们理解对话含义的上下文（Context）。在理解系统的业务需求时，同样需要借助这样的上下文，形成能够达成共识的知识语境【注：实际上英文单词Context本身就可以翻译为“语境”。】。限界上下文（Bounded Context）就是用一个清晰可见的边界（Bounded）将领域语言所在的上下文勾勒出来，并在边界内维持领域模型的一致性与完整性。

限界上下文形成的这种知识语境就好似对领域模型指定了“修饰定语”，翻译为代码，就是领域类所属的命名空间。例如，当我们谈论“合同”时，它的语义是模棱两可的，在引入“员工招聘”上下文后，“合同”这一领域概念就变得明朗了，它隐含地表示了“员工招聘的合同”这一概念，代码体现为recruitingcontext.Contract，在熟悉相关领域知识的人看来，也就是员工与公司签订的“劳务合同”。如此就保证了“合同”概念的清晰表达，不会与同一系统的其他“合同”概念混淆，例如属于营销上下文的“合同”，其本质含义是“销售合同”。

如果没有限界上下文的边界保护，建立的领域模型面向的是整个系统乃至整个企业，要保证领域概念的一致性，就需要为那些出现知识冲突的领域概念添加显式的定语修饰，如“合同”概念就需要明确细分，分别命名为“销售合同”、“租赁合同”、“培训合同”以及“劳务合同”。这些领域概念的命名都是在统一语言的指导下进行的，关键在于，当目标系统的问题空间变得规模庞大时，对应的统一语言也将变得规模庞大。一个目标系统需要多个团队共同协作完成，即使明确了这种显式定语修饰的规则，一个团队在不了解其他团队需要面对的领域知识的情况下，团队成员往往意识不到这种概念的冲突，从而选择适合自己团队的命名，不会刻意地保持与相似概念的不同。如果没有限界上下文的界定，就可能悄无声息地出现了领域概念的冲突而不自知。所以Eric Evans就提到：“在整个企业系统中保持这种水平的统一是一件得不偿失的事情。在系统的各个不同部门中开发多个模型是很有必要的，但我们必须慎重地选择系统的哪些部分可以分开，以及它们之间是什么关系。……大型系统领域模型的完全统一既不可行，也不划算。[13]”

这种“得不偿失”还体现在界定领域知识的难度上。要知道，领域概念的一致性与完整性并不仅仅体现在领域模型的命名上，它蕴含的业务规则也必须保证一致而完整。许多时候，在目标系统表达相同领域概念的模型对象，在不同上下文中，需要关注的领域知识也可能并不相同。Martin Fowler在解释限界上下文的文章[47]中，就给出了如图10-4所示的领域模型图： 


图10-4 领域概念冲突的领域模型，图来自[47]

销售人员和售后人员面对的客户（Customer）是同一个领域概念，机缘巧合下，甚至可能是同一个人，扮演的也是同一个角色。面对的产品（Product）也如此。然而，销售人员与售后人员因为工作内容和工作性质的不同，需要了解客户和产品的领域知识存在较大差异：销售人员为了精准营销，需要掌握客户的信息越详细越好，包括客户的职业、收入、消费习惯等，而售后人员为了提供售后服务，只需掌握客户的联系方式与联系地址就足矣。如果没有限界上下文引入的知识语境，要么就需要生搬硬造出一个个细小的具有修饰语的领域概念，要么就创造出一个合并了各种属性的庞大“上帝”类。

在问题空间，我们需要统一语言来形成团队对领域知识的共识。与其他设计元模式不同，统一语言是贯穿领域驱动设计统一过程始终的，它在架构映射阶段与领域建模阶段起到的作用就是维护领域模型的一致性。Eric Evans将模型的一致性视为模型的最基本要求：“模型最基本的要求是它应该保持内部一致，术语总具有相同的意义，并且不包含互相矛盾的规则：虽然我们很少明确地考虑这些要求。模型的内部一致性又叫做统一，在这种情况下，每个术语都不会有模棱两可的意义，也不会有规则冲突。除非模型在逻辑上是一致的，否则它就没有意义。[13]”显然，限界上下文的边界就是领域模型的边界，它的目的就在于维护领域模型的一致性，这一目的与统一语言的作用重合，因此可以认为：统一语言在解空间的作用域针对每个限界上下文。

10.2.2业务能力的纵向切分

要理解所谓“业务能力的纵向切分”，就要明确一个问题，为何领域驱动设计不使用模块（module）、服务（service）、库（libarary）或组件（component）这些耳熟能详的概念来表现业务能力？

要回答这一疑问，需要先弄清这些概念的真正含义，事实上，虽则我们频繁使用这些概念，对其定义还是懵懂不明。Neal Ford等人在《演进式架构》中言简意赅地给出了它们的定义和区别[46，P39]：“模块意味着逻辑分组，而组件意味着物理划分。”组件有两种物理划分形式，分别为库和服务：“库……往往和调用代码在相同的内存地址内运行，通过编程语言的函数调用机制进行通信。……服务倾向于在自己的地址空间中运行，通过低级网络协议（比如TCP/IP）、更高级的网络协议（比如SOAP），或REST进行通信。”

显然，模块属于逻辑架构视图的软件元素，组件（库和服务）属于物理架构视图的软件元素。模块与组件的区别体现了观察视图的不同，它们之间并不存在必然的映射关系。模块虽然是逻辑分组的结果，却不仅仅针对业务逻辑，某些基础设施的功能如文件操作、文件传输、网络通信等，也可以视为功能的逻辑划分，并在逻辑架构视图中被定义为模块，然后，在物理架构视图中根据具体的质量属性要求实现为库或者服务。为了与限界上下文做对比，不妨将体现了业务逻辑划分的模块称之为“业务模块”。

业务模块是否就是限界上下文呢？非也！因为模块作为体现职责内聚性的设计概念，它缺乏一套完整的架构体系支撑，边界是模糊不清的。业务模块是从业务角度针对纯粹的业务逻辑的归类与组织，仅此而已！它缺乏自顶向下端对端的独立架构，使得自身无法支撑业务能力的实现，如图10-5所示： 


图10-5 模块的划分【注：该图参考了《演进式架构》图4-11 P56】

图10-5所示的架构首先从技术维度进行关注点切分，形成一个分层架构；然后，业务模块又在此基础上针对业务层进行了领域维度[46, P56]的再度切分，封装了纯粹的领域逻辑。业务模块不具备独立的业务能力，只有把分散在各层中与对应领域维度有关的业务模块、数据访问模块以及数据库层的数据库或数据表整合起来，才能为展现层的页面模块提供完整的业务能力支撑。这正是业务模块的致命缺陷。分散在分层架构各个层次的领域维度切片也说明了模块的划分没有按照同一个业务变化方向进行，一旦该领域维度的业务逻辑发生变化，就需要更改整个系统的每一层。这正是我所谓的“模块缺乏一套完整架构体系支撑”的原因所在。

限界上下文与之相反。Eric Evans指出：“根据团队的组织、软件系统的各个部分的用法以及物理表现（代码和数据库模式等）来设置模型的边界。在这些边界中严格保持模型的一致性，而不要受到边界之外问题的干扰和混淆。[13]”这意味着限界上下文边界的控制力不只限于业务，还包括实现业务能力的技术内容，包括代码与数据库模式，它是对目标系统架构的纵向切分，切分的依据则是从业务进行考虑的领域维度。为了完整地满足业务能力的要求，在根据领域维度进行切分时，还需要考虑支撑业务能力的基础设施实现，如与该业务相关的数据访问逻辑，以及将领域知识进行持久化的数据库模型，形成纵向的逻辑边界，即限界上下文的边界。然后，在边界保护下从技术维度考虑内部的横向关注点切分，将业务逻辑与技术实现分离，形成限界上下文内部的独立架构。当然，考虑到前后端分离的架构以及用户体验的特殊性，通常限界上下文并不包含对展现层的纵向切分。形成的架构如图10-6所示： 

【修改，说明每个纵向的矩形就是一个限界上下文】


图10-6 纵向切分的限界上下文

对比图10-5与图10-6，可以发现模块与限界上下文在设计思想上的本质区别：

模块：先从技术维度进行横向切分，再从业务维度针对领域层进行纵向切分，业务模块仅包含业务逻辑，需要其他层模块的支持才能提供完整的业务能力。这样的架构没有将业务架构、应用架构、数据架构绑定起来，一旦业务发生变化，需要影响到横向层次的各个模块。

限界上下文：先从业务维度进行纵向切分，再从技术维度对限界上下文进行横向切分，因此限界上下文是一个对外暴露业务能力的架构整体。无论业务架构、应用架构还是数据架构都在一个边界中，一旦业务发生变化，只会影响到与该业务相关的限界上下文。

限界上下文的引入改变了架构的格局。限界上下文作为整体，与之强相关的领域维度切片被集中在一处，如此就能降低业务变化带来的影响，因为它影响的内容被收敛在一处。限界上下文自身又可视为一个小型的应用系统，按照关注点分离原则进行横向切分，把蕴含了业务逻辑的领域层单独剥离出来，形成了清晰的结构，隔离了业务复杂度与技术复杂度。

限界上下文是领域驱动设计战略层面最重要又最基本的架构设计单元。对外，限界上下文提供了清晰的边界，在边界保护下，整个目标系统的业务架构、应用架构与数据架构才能统一起来；对内，限界上下文的内部架构又确定了业务与技术的边界，实现了对技术架构的解耦。二者合一，就形成了业务能力的纵向切分。

【注：我会在后面章节结合整洁架构思想，引入分层架构与六边形架构发展出属于限界上下文的内部架构模式——菱形对称架构。】

10.2.3自治的架构单元

限界上下文作为一个基本的架构设计单元，既要体现领域模型的知识语境，又要能独立提供业务能力，这就要求它具有自治性，形成自治的架构单元。

什么是自治的架构单元？它具备四个特征：最小完备、自我履行、稳定空间和独立进化，限界上下文只有满足这四个特征，才能称为自治的架构单元，如图10-7所示。 


图10-7 自治的四个特征

最小完备是实现限界上下文自治的基本条件。所谓“完备”，是指限界上下文在履行属于自己的业务能力时，拥有的领域知识是完整的，无需针对自己的信息去求助别的限界上下文，这就避免了不必要的领域模型依赖。简言之，限界上下文的完备性，就是领域模型的完备性，也就是领域知识的完备性。当然，仅追求限界上下文的完备性是不够的，要知道，一个大而全的领域模型必然是完备的。为了避免领域模型被盲目扩大，就必须通过“最小”加以限制，避免将不必要的职责错误地添加到当前限界上下文。最小完备体现了限界上下文对领域知识的封装。最小完备体现了限界上下文对领域模型的界定。

自我履行意味着由限界上下文自己决定要做什么，就好似拥有了智能，能够根据自我拥有的知识对外部请求做出符合自身利益的明智判断。分配业务功能时，设计者就应该化身为限界上下文，模拟它进行思考：“我拥有足够的领域知识来履行这一职责吗？”如果做不到，而领域知识的分配又是合理的，就说明该职责不该由当前限界上下文承担。由于“履行”一词表达了职责意识，而非单纯地对数据或信息的拥有与传递，这就隐含地说明，当一个限界上下文具有自我履行的意识时，它就不会轻易突破边界，企图重用别人的领域模型，甚至绕过限界上下文直接访问不属于它的数据，而会优先以行为协作的方式履行自己的职责。自我履行体现了限界上下文对业务能力的承担。

稳定空间要求限界上下文必须防止和降低外部变化带来的影响。在满足了“最小完备”与“自我履行”特征的前提下，一个限界上下文已经拥有了必备的领域知识，即使这些领域知识代表的逻辑发生了变化，也是可控的。只有发生在限界上下文外界的变化，才鞭长莫及，力不从心。因此，要保证内部空间的稳定性，就是要解除或降低对外部软件元素的依赖，包括必须访问的环境资源如数据库、文件、消息队列等，也包括当前限界上下文之外的其他限界上下文或伴生系统。解决之道就是通过抽象降低耦合，只要保证访问接口的稳定性，外界的变化就不会产生影响。

稳定空间指的是减少外界变化对限界上下文内部的影响，独立进化则相反，指的是减少当限界上下文内部变化对外界产生的影响。这体现了边界的控制力，需要维持一个具有守护能力的“边疆”，对外公开稳定的接口，而将内部领域模型的变化封装在限界上下文的内部。显然，满足独立进化的核心思想是封装。抽象与封装都要求限界上下文划分合理而清晰的内外层次，在其边界内部形成独立的架构空间，即通过菱形对称架构【参见第13章】满足限界上下文响应变化的能力。

限界上下文的自治四要素相辅相成。最小完备是基础，只有赋予了限界上下文足够的知识，才能保证它的自我履行。稳定空间对内，独立进化对外，二者都是对变化的有效应对，而它们又是通过最小完备和自我履行来保证限界上下文受到变化的影响最小。遵循自治特性的限界上下文构成了整个系统的架构单元，成为响应业务变化与技术变化的关键支撑点。

10.2.4案例：供应链的商品模型

让我们通过供应链的一个案例，深刻体会自治的限界上下文与模块的不同之处。供应链系统的一个核心资源是商品（Product），无论是采购、订单、运输还是仓储，都需要用到商品的信息，因而需要在供应链系统的领域模型中定义“商品（Product）”模型。在未引入限界上下文边界之前，建立的领域模型如图10-8所示。


图10-8 供应链的领域模型

为了便于理解，图10-8仅仅展现了供应链系统整个领域模型的冰山一角，而将关注点放在与商品概念相关的领域模型。代表商品概念的Product类在整个领域模型中唯一表达了现实世界的商品概念；但在采购、报价、订单、运输以及仓储等不同视角中，商品却呈现了不同的面貌。例如，采购员在采购商品时，并不需要了解与运输相关的商品知识，如商品的高度、宽度与深度；运输商品时，配送人员并不关心商品的进价、最小起订量与供货周期。在没有边界的领域模型中，Product类若要完整呈现这些差异性，就必须包含与之相关的领域知识，使得Product领域模型变得越发的臃肿，最后可能被定义为图10-9所示的类。 
 

图10-9 Product类的定义

Product类涵盖了整个供应链系统范围的商品知识，由于没有边界限定这些知识，就可能因为模棱两可的定义引起领域概念的冲突。例如，管理仓储时，需要通过获得商品的高度，以便确定它在仓库的存放空间。于是，仓储团队在建模时为Product定义了height属性来代表商品的高度。运输商品时，运输团队也需要知道商品的高度，目的是为了计算每个包裹的占用空间。同样都是高度，在仓储和运输这两个场景中，代表了不同的含义。前者是真实的商品高度，用以计算存放空间，后者则为商品的包装高度，因为许多商品在运输时都需要打包，如果将它们混为一谈，就会引起计算错误。要在同一模型下避免这种冲突，就只能为属性添加定语修饰，如图10-9所示将高度分别定义为productHeight和shippingHeight。

这样一个庞大的Product类必然违背了“单一职责原则[48]"，它包含了多个引起它变化的原因。当采购功能对商品的需求发生变化时，需要修改它；当运输功能对商品的需求发生变化时，也需要修改它……它成为了一个极不稳定的“热点”（Hot Spot）。由于这样的类需要为不同的业务场景公开不同的信息，封装遭到了破坏，依赖变得更多，它就像一块巨大的磁铁，产生了强大的吸力，将与之相关的模块或类吸附其上，造成了业务逻辑的强耦合。

为供应链系统引入业务模块是否能解决这些问题呢？业务模块是对业务逻辑的划分，按照业务功能的划分，可以定义采购模块、运输模块、仓储模块、订单模块和商品模块，其中，在商品模块中定义了其他模块需要的Product类，形成如图10-10所示的模块结构。 


图10-10 引入业务模块

业务模块的划分看起来满足了封装领域模型的要求，但它并没有做到模型的统一，Product类被定义在商品模块中，并没有清晰表达它在各个业务场景中的意义与差异。由于模块内部缺乏一个层次清晰的架构来支撑，使得模块边界的控制能力被削弱了。如图10-10所示，各个模块的领域模型直接依赖了商品模块的Product类，根据共同重用原则（Common Reuse Principle，CRP）[48]，因为重用了Product类的定义，调用Product的业务模块都需要依赖商品业务模型。

当代表不同业务的业务模块被紧紧耦合在一起时，随着需求不断的变化，业务模块的边界就会变得越来越模糊。模块之间存在着若有若无的依赖，原本内聚的磁力缺乏了边界的有效隔离，就会慢慢吸附上诸多灰尘颗粒，渐渐填补了模块之间的空隙，变成了一个“大泥球”。一个直观的现象就是庞大的Product类在各个模块之间传来传去，而在Product类的实现中，随处可见采购、订单、运输与仓储等业务逻辑的踪影，形成了“你中有我、我中有你”的狎昵关系[9]。目标系统的架构因为缺乏空隙变得没有弹性，无法响应业务变化，架构的演化也会变得步履蹒跚。

显然，业务模块并没有针对一个完整业务进行业务能力的纵向切分，也没有考虑从领域模型的知识语境来划分边界，自治能力的缺失使得它的边界控制能力太弱，无法满足大型项目响应业务变化的架构需求。

限界上下文首先需要满足“最小完备”的自治特征，这就要求从知识完备的角度根据不同的知识语境划分专属于自己的领域模型。观察Product类蕴含的领域知识，它能够满足不同的业务场景。不同业务场景对商品领域知识的需要并不相同，但相同业务场景需要的商品领域知识往往又具有共同特征，这就在Product一个类中形成了多个具有不同内聚性的领域知识，如图10-11所示。


图10-11 不同内聚性的领域知识

如果我们不将商品的运输高度、宽度、是否装箱等领域知识赋给运输上下文，运输上下文就缺乏“完备性”，可要是将商品进价、最小起订量与供货周期也一股脑儿提供给它，就破坏了“最小性”对知识完备的约束了。因此，“最小完备”要求限界上下文对领域模型各取所需，拥有自己专属的领域模型，根据知识语境定义独立的Product类，形成限界上下文内部对商品的唯一表示，如图10-12所示。 


图10-12 对商品类形成知识语境

虽然不同的限界上下文都定义了Product类，但由于有了限界上下文作为边界，使得我们在理解领域模型时，是基于当前所在的上下文作为知识语境的，如ShoppingListItem关联的Product类表达了与采购相关的商品领域知识。倘若要确认多个限界上下文的商品是否属于同一件商品，就由商品上下文统一维护商品的唯一身份标识，限界上下文之间对Product类的依赖就被解除了，改为对productId的依赖，并由它维持商品的唯一性。

基于“自我履行”的要求，一个限界上下文应该根据自己拥有的信息判断职责该由谁来履行。例如，采购上下文希望获得商品的基本信息，这是它不具备的信息，只有交给拥有商品基本信息的商品上下文来履行。遵循“自我履行”的原则，一个限界上下文不会轻易突破自己的职责边界，也不会越俎代庖履行本该由别的限界上下文承担的职责。例如，订单上下文希望检查订单中商品的库存量是否满足购买需求，由于它拥有的信息不足以履行该职责，它就不能绕开本该履行检查库存量职责的库存上下文，直接访问存储了商品库存量的数据表，否则它就破坏了“自我履行”原则。

为了确保限界上下文“独立进化”的能力，需要定义开放主机服务（OHS，参见第11章）隔离位于限界上下文内部的领域模型。菱形对称架构【参见第13章】的北向网关保护了领域模型，不允许领域模型“穿透”限界上下文的边界。如果一个限界上下文想要获得另一个限界上下文的领域知识，需调用北向网关的服务，返回符合请求的消息契约模型。这一设计增加了消息契约模型与领域模型的转换成本，却避免了因重用领域模型带来的依赖，在一定程度上保留了独立进化的能力。例如，商品上下文自我履行了“获取商品基本信息”职责，库存上下文自我履行了“检查库存量”职责，它们都需要公开为服务的形式，并分别返回ProductResponse与InventoryResponse响应对象。

对内而言，如果限界上下文想要维持自己的“稳定空间”，就需要通过防腐层（ACL，参见第11章）来抵御外界变化带来的影响。例如，订单上下文需要调用库存上下文公开的“检查库存量”服务，为了抵御该服务可能的变化，就需要通过菱形对称架构的南向网关【参见第13章】建立抽象的客户端端口，将变化封装在适配器的实现中。库存上下文为了检查库存量，需要访问库存数据库。数据库属于外部的环境资源，为了不让它的变化影响领域模型，亦需要通过南向网关定义抽象的资源库端口，商品上下文获取商品信息同样如此。图10-13体现了各个限界上下文如何通过端口隔离了外部环境的变化。 


图10-13 利用抽象端口保证限界上下文的稳定性

对比业务模块，限界上下文更加淋漓尽致地展现了“自治”的特征。它通过其边界维持了各自领域模型的一致性，避免出现一个庞大而臃肿的领域模型，并利用内部的菱形对称架构保证了限界上下文之间的松散耦合，支撑了它对业务能力的实现，建立了保证领域模型不受污染的边界屏障。

10.3识别限界上下文

不少领域驱动设计专家都非常重视限界上下文，越来越多的实践者也看到了它的重要性。Mike Mogosanu认为：“限界上下文是领域驱动设计中最难解释的原则，但或许也是最重要的原则。可以说，没有限界上下文，就不能做领域驱动设计。在了解聚合根（Aggregate Root）、聚合（Aggregate）、实体（Entity）等概念之前，需要先了解限界上下文。”经过前面对限界上下文的分析，我认为足以了解限界上下文；然而，限界上下文不会自我呈现，我们需要像猎人一般去探寻它的痕迹，捕捉到它的身影。遗憾的是，就连领域驱动设计之父Eric Evans对如何识别限界上下文，亦是语焉不详。

识别限界上下文的质量直接制约我们的设计，而高明的架构师雅擅于此，一个个限界上下文跃然于纸上，当我们惊叹于概念的准确性和边界的合理性时，问其如何获得，他们却笑称这是妙手偶得。软件设计亦是一门艺术，似乎需要凭借一种妙至毫巅、心领神会的神秘力量，刹那之间迸发灵感，于是，设计的奇思妙想就产生了。实情当然不是这样，若要说真的存在秘而不宣的神奇力量，那就是架构师们千锤百炼造就的“经验”。

Andy Hunt分析了德雷福斯模型（Dreyfus Model）的5个成长阶段：新手、高级新手、胜任者、精通者和专家。对于最高阶段的“专家”，Andy Hunt得出一个有趣的结论：“专家根据直觉工作（Experts work from intuition），而不需要理由。[54]”这一结论充满了神秘主义，反复回味，却又理所当然，专家的“直觉”实际就是通过不断的项目实践磨炼出来的，正所谓厚积薄发。当然，经验的累积过程需要方法，否则所谓数年经验不过是相同的经验重复多次，没有价值。Andy Hunt认为：需要给新手提供某种形式的规则去参照，之后，高级新手会逐渐形成一些总体原则，然后通过系统思考和自我纠正，建立或者遵循一套体系方法，就能从高级新手慢慢成长为胜任者、精通者乃至于专家。因此，从新手到专家是一个量变引起质变的过程，在没有能够养成直觉的经验之前，我们需要一套方法。

Edward Crawley谈到系统思考者在对复杂系统进行分析或综合时可以运用的技巧：“自顶向下（top-down）和自底向上（bottom-up）是思考系统时的两种方向。……我们先从系统的目标开始，然后思考概念及高层架构。在制定架构时，我们会反复地对架构进行细化，并在我们所关注的范围内，把架构中的实体分解到最小。……自底向上……就是先思考工件、能力或服务等最底层的实体，然后沿着这些实体向上构建，以预测系统的涌现物。除了这两种方式外，还有一种方法是同时从顶部和底部向中间行进，这叫做由外向内（outer-in）的思考方式。”[21，P44]在识别限界上下文时，可以借鉴这一思路。

10.3.1业务维度

识别限界上下文的过程，就是将问题空间的业务需求映射到解空间限界上下文的过程。全局分析阶段的业务需求分析工作流采取自顶向下的分析方法，问题空间中的业务流程根据时间维度切分为各个相对独立的业务场景，再根据角色维度将业务场景分解为业务活动；然后，架构映射阶段的业务级映射工作流又采取自底向上的求解方法，从业务活动逆行而上，通过逐步的归类与归纳获得体现业务能力的限界上下文。问题空间的分析过程与解空间的求解过程共同组成了如图10-14所示的识别限界上下文的V型映射过程。 


图10-14 V型映射过程【修改，将图中的业务边界改为业务主体，是归类与归纳形成业务主体，根据亲密度与知识语境对边界进行梳理形成限界上下文】

整个映射过程从分解、归类到归纳形成了一套相对固化的映射过程，可以在一定程度上消解我们对经验的依赖。同时作为分析过程终点与求解过程起点的业务活动，成为了V型映射过程的交叉点。它是一个抽象的概念，代表了由角色参与的具有业务价值的领域行为。在分析阶段，对应于全局分析的业务分析，如果采用用例建模，业务活动就是系统用例；如果采用事件风暴，业务活动就是事件。到了求解阶段，就无所谓用例还是事件，本质上都是从业务维度按照业务相关性将业务活动归类到同一个业务主体，再通过归纳为其命名，获得解空间的限界上下文。

1.                   理解了这一概念之后提炼出来的[56，P172]。识别限界上下文时，归纳业务知识的过程就是抽象的过程，限界上下文的名称代表了一个抽象的概念，因此，我们可以将单一抽象层次原则运用到限界上下文的识别过程中。

要理解单一抽象层次原则，就需要了解什么是概念的抽象层次？

首先，抽象这个词的拉丁文为abstractio，原意为排除、抽出。中文对这个词语的翻译也很巧妙，可以顾名思义理解为抽出具体形象的东西。例如人是一个抽象的概念，一个具体的人有性别、年龄、身高、相貌、社会关系等具体特征，而抽象的人就是不包含这些具体特征的一个概念。抽象概念指代一类事物，因此，抽象实际上并非真正抽出这些具体特征，而是对一类具有共同特征的事物进行归纳，从而抹掉了具体类型之间的差异。

抽象层次与概念的内涵有关，概念的内涵即为事物的特征。内涵越小，意味着抽象的特征越少，抽象的层次就越高，外延也越大，反之亦然。例如男人和女人有性别特征的具体值，人抽象了性别特征，使得该概念的内涵要少于男人或女人，而外延的范围却更大，抽象层次也就更高。同理，生物的概念层次要高于人，物质的概念层次又要高于生物。

倘若限界上下文没有遵循单一抽象层次原则，概念层次就会出现混乱。一个高抽象层次的概念由于内涵更小，使得它的外延更大，就有可能包含低抽象层次的概念，使得位于不同抽象层次的限界上下文存在概念上的包含关系，也就违背了正交原则。